import{r as a}from"./mui-core-CIRgtlGz.js";import{c as e,C as t,A as n,H as r,U as o}from"../index-BM7OiNGa.js";const i=(i={})=>{const{light:s=!1,enablePolling:c=!0}=i,[d,l]=a.useState([]),[u,p]=a.useState(!0),[f,m]=a.useState(null),h=a.useRef(!1),_=a.useCallback(async(a=!1)=>{try{a||p(!0),m(null);const c=(await e.get(t.conversaciones)).data;let d=c;if(s)d=c.map(a=>({...a,unreadCount:a.mensajes_no_leidos||0,actualizado_en:a.fecha_actualizacion||a.actualizado_en}));else{const a=(await e.get(n.USER)).data.id,t=(await e.get(r)).data.reduce((a,e)=>(a[e.id]=e.nombre_habilidad,a),{}),s=new Set;c.forEach(e=>{e.participantes?.forEach(e=>{e!==a&&s.add(e)})});const l={};if(s.size>0)for(const n of s)try{const a=await e.get(o.detalle(n));l[n]=a.data}catch(i){l[n]={id:n,nombre:"Usuario",apellido:"Desconocido"}}d=c.map(e=>{const n=e.participantes?.find(e=>e!==a),r=l[n]||{id:n,nombre:"Usuario",apellido:"Desconocido"};return{...e,otherUser:r,unreadCount:e.mensajes_no_leidos||0,actualizado_en:e.fecha_actualizacion||e.actualizado_en,skillsMap:t}})}d.sort((a,e)=>new Date(e.actualizado_en)-new Date(a.actualizado_en)),l(a=>{if(a.length!==d.length)return d;const e=a[0]?.actualizado_en,t=d[0]?.actualizado_en;return e!==t?d:a})}catch(i){404===i.response?.status?(m(null),l([])):m(i.response?.data?.detail||"Error al cargar conversaciones")}finally{p(!1)}},[]),g=a.useCallback(async a=>{try{const n=(await e.get(t.conversaciones)).data.find(e=>e.participantes&&e.participantes.includes(a));if(n)return n;const r=await e.post(t.conversaciones,{participantes:[a]});return await _(),r.data}catch(n){throw n}},[_]),v=a.useCallback(async a=>{try{await e.post(t.marcarLeido(a)),l(e=>e.map(e=>e.id===a?{...e,unreadCount:0}:e))}catch(n){}},[]),y=Array.isArray(d)?d.reduce((a,e)=>a+("number"==typeof e?.unreadCount?e.unreadCount:0),0):0;return a.useEffect(()=>{h.current||(h.current=!0,_())},[]),a.useEffect(()=>{if(!c)return;let a=null;const e=()=>{a||(a=setInterval(()=>{document.hidden||_(!0)},12e4))},t=()=>{a&&(clearInterval(a),a=null)},n=()=>{document.hidden?t():(_(!0),e())};return document.hidden||e(),document.addEventListener("visibilitychange",n),()=>{document.removeEventListener("visibilitychange",n),t()}},[c,_]),{conversations:d,loading:u,error:f,fetchConversations:_,getOrCreateConversation:g,markAsRead:v,totalUnread:y}};export{i as u};
