import{r as a}from"./mui-core-BpoTvZsj.js";import{c as e,C as t,A as n,H as o,U as r}from"../index-BF7ALLnG.js";const i=(i={})=>{const{light:s=!1,enablePolling:c=!0}=i,[d,l]=a.useState([]),[u,p]=a.useState(!0),[f,m]=a.useState(null),h=a.useRef(!1),v=a.useCallback(async(a=!1)=>{try{a||p(!0),m(null);const c=(await e.get(t.conversaciones)).data;let d=c;if(s)d=c.map(a=>({...a,unreadCount:a.mensajes_no_leidos||0,actualizado_en:a.fecha_actualizacion||a.actualizado_en}));else{const a=(await e.get(n.USER)).data.id,t=(await e.get(o)).data.reduce((a,e)=>(a[e.id]=e.nombre_habilidad,a),{}),s=new Set;c.forEach(e=>{e.participantes?.forEach(e=>{e!==a&&s.add(e)})});const l={};if(s.size>0)for(const n of s)try{const a=await e.get(r.detalle(n));l[n]=a.data}catch(i){l[n]={id:n,nombre:"Usuario",apellido:"Desconocido"}}d=c.map(e=>{const n=e.participantes?.find(e=>e!==a),o=l[n]||{id:n,nombre:"Usuario",apellido:"Desconocido"};return{...e,otherUser:o,unreadCount:e.mensajes_no_leidos||0,actualizado_en:e.fecha_actualizacion||e.actualizado_en,skillsMap:t}})}d.sort((a,e)=>new Date(e.actualizado_en)-new Date(a.actualizado_en)),l(d)}catch(i){404===i.response?.status?(m(null),l([])):m(i.response?.data?.detail||"Error al cargar conversaciones")}finally{p(!1)}},[]),y=a.useCallback(async a=>{try{const n=(await e.get(t.conversaciones)).data.find(e=>e.participantes&&e.participantes.includes(a));if(n)return n;const o=await e.post(t.conversaciones,{participantes:[a]});return await v(),o.data}catch(n){throw n}},[v]),_=a.useCallback(async a=>{try{await e.post(t.marcarLeido(a)),l(e=>e.map(e=>e.id===a?{...e,unreadCount:0}:e))}catch(n){}},[]),g=Array.isArray(d)?d.reduce((a,e)=>a+("number"==typeof e?.unreadCount?e.unreadCount:0),0):0;return a.useEffect(()=>{h.current||(h.current=!0,v())},[]),a.useEffect(()=>{if(!c)return;let a=null;const e=()=>{a||(a=setInterval(()=>{document.hidden||v(!0)},12e4))},t=()=>{a&&(clearInterval(a),a=null)},n=()=>{document.hidden?t():(v(!0),e())};return document.hidden||e(),document.addEventListener("visibilitychange",n),()=>{document.removeEventListener("visibilitychange",n),t()}},[c,v]),{conversations:d,loading:u,error:f,fetchConversations:v,getOrCreateConversation:y,markAsRead:_,totalUnread:g}};export{i as u};
